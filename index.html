<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Innovation Dash: Race to the Future</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Custom scrollbar for event log */
        .event-log::-webkit-scrollbar {
            width: 6px;
        }
        .event-log::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        .event-log::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        .event-log::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* Simple modal styling */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); /* Dim background */
            padding-top: 60px;
            align-items: center; /* Vertical centering */
            justify-content: center; /* Horizontal centering */
        }
        .modal-content {
            background-color: #fefefe;
           /* margin: 5% auto; */ /* Removed for flex centering */
            padding: 20px;
            border: 1px solid #888;
            width: 90%; /* More responsive width */
            max-width: 600px;
            border-radius: 0.5rem; /* Rounded corners */
            position: relative;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
        }
        /* TRL Progress Bar */
        .trl-progress-bg {
            background-color: #e5e7eb; /* Gray background */
            border-radius: 0.375rem; /* Rounded */
            overflow: hidden;
            height: 1rem; /* Fixed height */
        }
        .trl-progress-bar {
            background-color: #3b82f6; /* Blue progress */
            height: 100%;
            border-radius: 0.375rem;
            transition: width 0.5s ease-in-out;
            text-align: center;
            color: white;
            font-size: 0.75rem; /* Smaller text */
            line-height: 1rem; /* Center text vertically */
        }
         /* Simple animation for event messages */
        .event-item {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Energy Innovation Dash</h1>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-100 rounded-lg">
            <div>
                <h2 class="text-lg font-semibold text-gray-700">Player: <span id="player-name" class="font-normal">N/A</span></h2>
                <p class="text-sm text-gray-600" id="player-description"></p>
            </div>
            <div class="text-center">
                <h2 class="text-lg font-semibold text-gray-700">Turn: <span id="turn-counter">0</span> / <span id="max-turns">15</span> (<span id="current-year">2025</span>)</h2>
                <p class="text-lg font-semibold text-green-600">Score: <span id="player-score">0</span></p>
            </div>
            <div class="text-right">
                <h3 class="text-md font-semibold text-gray-700">Resources</h3>
                <p class="text-sm text-gray-600">Public R&D: $<span id="public-funds">0</span> M</p>
                <p class="text-sm text-gray-600">Corp R&D: $<span id="corp-funds">0</span> M</p>
                <p class="text-sm text-gray-600">VC Funds: $<span id="vc-funds">0</span> M</p>
                <p class="text-sm text-gray-600">Research Pts: <span id="research-points">0</span></p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <div class="lg:col-span-2">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Technology Pathways</h2>
                <div id="tech-pathways" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>
            </div>

            <div>
                <div>
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Races to Firsts</h2>
                    <div id="races-container" class="space-y-3">
                        </div>
                </div>

                <div class="mt-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Event Log</h2>
                    <div id="event-log" class="h-64 overflow-y-auto p-3 bg-gray-50 rounded-lg border border-gray-200 event-log space-y-2">
                        <p class="text-gray-500 italic">Game started. Choose your player.</p>
                    </div>
                </div>

                <div class="mt-6 text-center">
                    <button id="end-turn-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed" disabled>End Turn (<span id="current-year-btn">2025</span>)</button>
                </div>
            </div>
        </div>
    </div>

    <div id="player-select-modal" class="modal" style="display: flex;"> <div class="modal-content">
             <h2 class="text-xl font-bold mb-4 text-center">Choose Your Faction</h2>
             <p class="text-center mb-4 text-gray-600">Select a region or corporation to lead the energy innovation race!</p>
             <div id="player-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                 </div>
        </div>
    </div>

    <div id="event-modal" class="modal" style="display: none;"> <div class="modal-content">
            <span id="event-modal-close" class="close-button">&times;</span>
            <h2 class="text-xl font-bold mb-4 text-center">Event Occurred!</h2>
            <p id="event-description" class="text-center text-gray-700 mb-4"></p>
            <div class="text-center">
                 <button id="event-modal-ok" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Acknowledge</button>
            </div>
        </div>
    </div>

     <div id="investment-modal" class="modal" style="display: none;"> <div class="modal-content">
            <span id="investment-modal-close" class="close-button">&times;</span>
            <h2 class="text-xl font-bold mb-4 text-center">Invest in <span id="invest-tech-name">Technology</span></h2>
            <p class="text-sm text-gray-600 mb-2">Current TRL: <span id="invest-tech-trl">0</span>/9</p>
            <p class="text-sm text-gray-600 mb-4">Cost to next TRL attempt: $<span id="invest-tech-cost">0</span> M Public/Corp R&D, <span id="invest-tech-rp-cost">0</span> Research Pts</p>

            <div class="mb-4">
                <label for="public-investment" class="block text-sm font-medium text-gray-700">Public R&D Investment ($M):</label>
                <input type="number" id="public-investment" min="0" value="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <p class="text-xs text-gray-500">Available: $<span id="modal-public-funds">0</span> M</p>
            </div>
            <div class="mb-4">
                <label for="corp-investment" class="block text-sm font-medium text-gray-700">Corporate R&D Investment ($M):</label>
                <input type="number" id="corp-investment" min="0" value="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                 <p class="text-xs text-gray-500">Available: $<span id="modal-corp-funds">0</span> M</p>
           </div>
            <div class="mb-4">
                <label for="rp-investment" class="block text-sm font-medium text-gray-700">Research Points Investment:</label>
                <input type="number" id="rp-investment" min="0" value="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                 <p class="text-xs text-gray-500">Available: <span id="modal-research-points">0</span></p>
            </div>
             <p class="text-sm text-red-600 mb-4" id="investment-error" style="display: none;">Insufficient funds or research points.</p>

            <div class="text-center">
                 <button id="confirm-investment-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mr-2">Confirm Investment</button>
                 <button id="investment-modal-cancel" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>

     <div id="game-over-modal" class="modal" style="display: none;"> <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4 text-center">Game Over!</h2>
            <p id="game-over-message" class="text-center text-lg text-gray-700 mb-4"></p>
            <p class="text-center text-xl font-semibold text-green-600 mb-6">Final Score: <span id="final-score">0</span></p>
            <div class="text-center">
                 <button onclick="window.location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Play Again?</button>
            </div>
        </div>
    </div>


    <script>
        // --- Game Configuration ---
        const MAX_TURNS = 15; // Game ends after 15 turns (e.g., 2025-2040)
        const START_YEAR = 2025;
        const BASE_TRL_COST_MONEY = 50; // Base cost in $M to attempt TRL increase
        const BASE_TRL_COST_RP = 5;     // Base cost in Research Points to attempt TRL increase
        const TRL_COST_MULTIPLIER = 1.5; // Cost increases for higher TRLs
        const BASE_TRL_SUCCESS_RATE = 0.5; // 50% base chance to increase TRL if fully funded
        const RESEARCH_POINTS_PER_TURN = 10;
        const VC_FUNDS_BASE = 30; // Base VC funds per turn ($M)
        const VC_FUNDS_VOLATILITY = 20; // Max random variation in VC funds ($M, +/-)

        // --- Player Factions ---
        const factions = {
            'USA Inc.': {
                name: 'USA Inc.',
                description: 'Strong VC market, balanced tech portfolio. Starts with higher VC funds but potentially slower public R&D growth.',
                startPublicFunds: 100,
                startCorpFunds: 150,
                startVCFunds: 200, // Higher VC
                startRP: 20,
                bonuses: { vcMultiplier: 1.2, publicFundsGrowth: 0.04 }, // Slightly better VC, slightly lower public growth
                startTechLevels: { 'Solar PV': 7, 'Wind Power': 7, 'Li-ion Batteries': 7, 'Next-Gen Batteries': 3, 'Hydrogen (Green)': 4, 'CCUS/CDR': 4, 'AI for Energy': 5, 'Advanced Nuclear': 4 } // Adjusted Next-Gen start
            },
            'EU Innovate': {
                name: 'EU Innovate',
                description: 'Strong public R&D focus, excels in complex projects. Starts with higher public funds and RP, but lower VC.',
                startPublicFunds: 150, // Higher Public R&D
                startCorpFunds: 100,
                startVCFunds: 100,
                startRP: 30, // Higher RP
                bonuses: { publicFundsGrowth: 0.06, corpFundsGrowth: 0.05 }, // Good public/corp growth
                startTechLevels: { 'Solar PV': 6, 'Wind Power': 7, 'Li-ion Batteries': 6, 'Next-Gen Batteries': 2, 'Hydrogen (Green)': 5, 'CCUS/CDR': 5, 'AI for Energy': 4, 'Advanced Nuclear': 5 }
            },
            'Dragon Tech': {
                name: 'Dragon Tech',
                description: 'Dominant in manufacturing & patents for modular tech. Strong corporate investment, rapid scaling potential for certain techs.',
                startPublicFunds: 120,
                startCorpFunds: 200, // Higher Corp R&D
                startVCFunds: 150,
                startRP: 25,
                bonuses: { corpFundsGrowth: 0.07, modularTechBonus: 0.1 }, // High corp growth, bonus for batteries/solar TRL chance
                startTechLevels: { 'Solar PV': 8, 'Wind Power': 6, 'Li-ion Batteries': 8, 'Next-Gen Batteries': 3, 'Hydrogen (Green)': 3, 'CCUS/CDR': 4, 'AI for Energy': 6, 'Advanced Nuclear': 3 }
            },
            'Global South Collective': {
                name: 'Global South Collective',
                description: 'Faces funding challenges but has high potential and lower starting costs for some basic R&D. Focus on adaptation and leapfrogging.',
                startPublicFunds: 50, // Lower funds
                startCorpFunds: 50,
                startVCFunds: 50,
                startRP: 15,
                bonuses: { lowerEarlyTRLCost: 0.8, vcMultiplier: 0.8 }, // Cheaper early R&D, harder to attract VC
                startTechLevels: { 'Solar PV': 5, 'Wind Power': 5, 'Li-ion Batteries': 4, 'Next-Gen Batteries': 1, 'Hydrogen (Green)': 2, 'CCUS/CDR': 2, 'AI for Energy': 3, 'Advanced Nuclear': 2 }
            }
        };

        // --- Technology Pathways ---
        const technologies = {
            'Solar PV': { name: 'Solar PV', description: 'Photovoltaic power generation, including perovskites.', trl: 0, patents: 0 },
            'Wind Power': { name: 'Wind Power', description: 'Onshore and offshore wind turbines, including floating.', trl: 0, patents: 0 },
            'Li-ion Batteries': { name: 'Li-ion Batteries', description: 'Dominant battery tech for EVs and storage.', trl: 0, patents: 0 },
            'Next-Gen Batteries': { name: 'Next-Gen Batteries', description: 'Solid-state, Sodium-ion, new chemistries.', trl: 0, patents: 0 }, // Base start TRL 0, factions adjust
            'Hydrogen (Green)': { name: 'Hydrogen (Green)', description: 'Electrolysis for low-emission hydrogen production.', trl: 0, patents: 0 },
            'CCUS/CDR': { name: 'CCUS/CDR', description: 'Carbon Capture, Utilization, Storage & Direct Air Capture.', trl: 0, patents: 0 },
            'Advanced Nuclear': { name: 'Advanced Nuclear', description: 'Small Modular Reactors (SMRs) and Fusion concepts.', trl: 0, patents: 0 },
            'AI for Energy': { name: 'AI for Energy', description: 'AI applications for materials discovery, grid optimization, etc. Boosts other R&D.', trl: 0, patents: 0 }
        };

        // --- Races to Firsts ---
        const races = {
            'Commercial SMR Deployment': { name: 'Commercial SMR Deployment', description: 'First grid-connected, repeatedly deployable SMR.', targetTRL: 8, techDependency: 'Advanced Nuclear', cost: 500, progress: 0, completed: false, reward: 100 },
            'Low-Cost Green Hydrogen (<$2/kg)': { name: 'Low-Cost Green Hydrogen (<$2/kg)', description: 'Achieve large-scale production below $2/kg.', targetTRL: 7, techDependency: 'Hydrogen (Green)', cost: 400, progress: 0, completed: false, reward: 80 },
            'Scaled Direct Air Capture (DAC)': { name: 'Scaled Direct Air Capture (DAC)', description: 'Operational DAC facility removing >100k tons CO2/year.', targetTRL: 7, techDependency: 'CCUS/CDR', cost: 450, progress: 0, completed: false, reward: 90 },
            'Viable Solid-State Battery': { name: 'Viable Solid-State Battery', description: 'Demonstrate a commercially promising solid-state EV battery.', targetTRL: 6, techDependency: 'Next-Gen Batteries', cost: 300, progress: 0, completed: false, reward: 70 }
        };

        // --- Event Cards ---
        const events = [
             { name: "Global Policy Push", description: "Major economies commit to climate goals. +20% Public R&D funds next turn.", effect: (gs) => { gs.publicFundsBonus = 1.2; logEvent("Global Policy Push boosts public R&D funding next turn!"); } },
            { name: "VC Market Boom", description: "Venture Capital flows freely! +50% VC funds next turn.", effect: (gs) => { gs.vcFundsMultiplier = 1.5; logEvent("Venture Capital market is booming!"); } },
            { name: "VC Market Bust", description: "Investors pull back. -50% VC funds next turn.", effect: (gs) => { gs.vcFundsMultiplier = 0.5; logEvent("Venture Capital market tightens significantly."); } },
            { name: "Geopolitical Tensions", description: "Supply chain disruptions impact battery materials. Next-Gen Battery R&D cost x1.5 next turn.", effect: (gs) => { gs.techCostMultipliers['Next-Gen Batteries'] = 1.5; logEvent("Geopolitical tensions increase costs for battery R&D."); } },
            { name: "AI Breakthrough", description: "Advances in AI accelerate research globally. +10% TRL success chance for all techs next turn.", effect: (gs) => { gs.globalTRLBonus = 0.1; logEvent("AI breakthrough accelerates R&D across the board!"); } },
            { name: "Corporate R&D Surge", description: "Industry doubles down on innovation. +20% Corporate R&D funds next turn.", effect: (gs) => { gs.corpFundsBonus = 1.2; logEvent("Corporations increase their R&D spending!"); } },
            { name: "Demonstration Setback", description: "A major demonstration project faces delays. -10 Score.", effect: (gs) => { gs.score = Math.max(0, gs.score - 10); logEvent("Setback reported for a major demonstration project."); } }, // Prevent negative score
            { name: "Patent Dispute", description: "Legal battles slow progress in a key area. -10 Research Points.", effect: (gs) => { gs.researchPoints = Math.max(0, gs.researchPoints - 10); logEvent("Patent disputes hinder research efforts."); } },
            { name: "Unexpected Discovery", description: "Researchers make a leap in a random tech. +1 TRL for one random technology.", effect: (gs) => {
                const techKeys = Object.keys(gs.technologies);
                const randomTechKey = techKeys[Math.floor(Math.random() * techKeys.length)];
                if (gs.technologies[randomTechKey].trl < 9) {
                    gs.technologies[randomTechKey].trl++;
                    logEvent(`Unexpected discovery advances ${randomTechKey} to TRL ${gs.technologies[randomTechKey].trl}!`);
                    updateTechnologyCard(randomTechKey); // Update card immediately
                } else {
                     logEvent(`Unexpected discovery in ${randomTechKey}, but it's already max TRL.`);
                }
            }},
            { name: "Favorable Regulations", description: "New standards boost demand for a specific technology. +10% success chance for one random tech next turn.", effect: (gs) => {
                 const techKeys = Object.keys(gs.technologies);
                const randomTechKey = techKeys[Math.floor(Math.random() * techKeys.length)];
                gs.techSuccessBonus[randomTechKey] = (gs.techSuccessBonus[randomTechKey] || 0) + 0.1;
                 logEvent(`Favorable regulations provide a boost for ${randomTechKey} development!`);
            }},
             { name: "Economic Slowdown", description: "Global economy slows, budgets tighten. -10% Public & Corp R&D funds next turn.", effect: (gs) => { gs.publicFundsBonus = 0.9; gs.corpFundsBonus = 0.9; logEvent("Economic slowdown leads to tighter budgets."); } },
             { name: "EMDE Leapfrog Opportunity", description: "A developing nation shows rapid adoption potential. +15 Research Points.", effect: (gs) => { gs.researchPoints += 15; logEvent("Emerging market shows potential for technology leapfrogging!"); } },
             { name: "Stable Conditions", description: "A period of relative stability allows focused development.", effect: (gs) => { logEvent("Conditions are stable, allowing for focused R&D efforts."); } }, // Neutral event
             { name: "Skills Shortage", description: "Lack of skilled personnel slows complex projects. -5 Research Points.", effect: (gs) => { gs.researchPoints = Math.max(0, gs.researchPoints - 5); logEvent("Skills shortages impact R&D capacity."); } }, // Minor negative RP event
        ];

        // --- Game State ---
        let gameState = {
            turn: 0,
            maxTurns: MAX_TURNS,
            currentYear: START_YEAR,
            selectedFaction: null,
            publicFunds: 0,
            corpFunds: 0,
            vcFunds: 0,
            researchPoints: 0,
            score: 0,
            technologies: {},
            races: {}, // Initialize empty, will be deep copied
            bonuses: {},
            // Modifiers reset each turn before event/funding
            publicFundsBonus: 1.0,
            corpFundsBonus: 1.0,
            vcFundsMultiplier: 1.0,
            globalTRLBonus: 0.0,
            techCostMultipliers: {},
            techSuccessBonus: {},
            gameOver: false,
            investingTechKey: null
        };

        // --- DOM Elements (get references after DOM loaded) ---
        let playerNameEl, playerDescEl, turnCounterEl, maxTurnsEl, currentYearEl, playerScoreEl;
        let publicFundsEl, corpFundsEl, vcFundsEl, researchPointsEl;
        let techPathwaysContainer, racesContainer, eventLogEl, endTurnButton, currentYearBtnEl;
        let playerSelectModal, playerOptionsContainer, eventModal, eventDescriptionEl;
        let investmentModal, investTechNameEl, investTechTrlEl, investTechCostEl, investTechRpCostEl;
        let publicInvestmentInput, corpInvestmentInput, rpInvestmentInput;
        let modalPublicFundsEl, modalCorpFundsEl, modalResearchPointsEl, investmentErrorEl, confirmInvestmentButton;
        let gameOverModal, gameOverMessageEl, finalScoreEl;
        let eventModalClose, eventModalOk, investmentModalClose, investmentModalCancel; // Added for modal buttons

        function getDOMElements() {
             playerNameEl = document.getElementById('player-name');
             playerDescEl = document.getElementById('player-description');
             turnCounterEl = document.getElementById('turn-counter');
             maxTurnsEl = document.getElementById('max-turns');
             currentYearEl = document.getElementById('current-year');
             playerScoreEl = document.getElementById('player-score');
             publicFundsEl = document.getElementById('public-funds');
             corpFundsEl = document.getElementById('corp-funds');
             vcFundsEl = document.getElementById('vc-funds');
             researchPointsEl = document.getElementById('research-points');
             techPathwaysContainer = document.getElementById('tech-pathways');
             racesContainer = document.getElementById('races-container');
             eventLogEl = document.getElementById('event-log');
             endTurnButton = document.getElementById('end-turn-button');
             currentYearBtnEl = document.getElementById('current-year-btn');
             playerSelectModal = document.getElementById('player-select-modal');
             playerOptionsContainer = document.getElementById('player-options');
             eventModal = document.getElementById('event-modal');
             eventDescriptionEl = document.getElementById('event-description');
             investmentModal = document.getElementById('investment-modal');
             investTechNameEl = document.getElementById('invest-tech-name');
             investTechTrlEl = document.getElementById('invest-tech-trl');
             investTechCostEl = document.getElementById('invest-tech-cost');
             investTechRpCostEl = document.getElementById('invest-tech-rp-cost');
             publicInvestmentInput = document.getElementById('public-investment');
             corpInvestmentInput = document.getElementById('corp-investment');
             rpInvestmentInput = document.getElementById('rp-investment');
             modalPublicFundsEl = document.getElementById('modal-public-funds');
             modalCorpFundsEl = document.getElementById('modal-corp-funds');
             modalResearchPointsEl = document.getElementById('modal-research-points');
             investmentErrorEl = document.getElementById('investment-error');
             confirmInvestmentButton = document.getElementById('confirm-investment-button');
             gameOverModal = document.getElementById('game-over-modal');
             gameOverMessageEl = document.getElementById('game-over-message');
             finalScoreEl = document.getElementById('final-score');
             // Modal Buttons
             eventModalClose = document.getElementById('event-modal-close');
             eventModalOk = document.getElementById('event-modal-ok');
             investmentModalClose = document.getElementById('investment-modal-close');
             investmentModalCancel = document.getElementById('investment-modal-cancel');
        }


        // --- Game Logic Functions ---

        function initGame() {
            console.log("Initializing game...");
            getDOMElements(); // Get references to DOM elements
            setupEventListeners(); // Setup listeners for modal buttons etc.
            renderPlayerOptions();
            // Game starts properly after player selection
        }

         function setupEventListeners() {
            endTurnButton.addEventListener('click', endTurn);
            confirmInvestmentButton.addEventListener('click', handleConfirmInvestment);

            // Modal close buttons
            eventModalClose.addEventListener('click', () => handleEventModalClose());
            eventModalOk.addEventListener('click', () => handleEventModalClose());
            investmentModalClose.addEventListener('click', () => closeModal('investment-modal'));
            investmentModalCancel.addEventListener('click', () => closeModal('investment-modal'));


            // Close modals if clicked outside content (optional but good UX)
            window.addEventListener('click', function(event) {
                if (event.target == eventModal) handleEventModalClose();
                if (event.target == investmentModal) closeModal('investment-modal');
                // No outside click close for player select or game over
            });
        }

        function renderPlayerOptions() {
            playerOptionsContainer.innerHTML = ''; // Clear previous options
            Object.values(factions).forEach(faction => {
                const button = document.createElement('button');
                button.className = 'bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow transition duration-150 ease-in-out text-left';
                button.innerHTML = `
                    <h3 class="text-lg font-semibold">${faction.name}</h3>
                    <p class="text-sm font-normal">${faction.description}</p>
                `;
                button.onclick = () => selectFaction(faction.name);
                playerOptionsContainer.appendChild(button);
            });
        }

        function selectFaction(factionName) {
            console.log("Faction selected:", factionName);
            // *** FIX: Close modal EARLY ***
            closeModal('player-select-modal');

            gameState.selectedFaction = factions[factionName];
            gameState.publicFunds = gameState.selectedFaction.startPublicFunds;
            gameState.corpFunds = gameState.selectedFaction.startCorpFunds;
            gameState.vcFunds = gameState.selectedFaction.startVCFunds;
            gameState.researchPoints = gameState.selectedFaction.startRP;
            gameState.bonuses = { ...gameState.selectedFaction.bonuses }; // Shallow copy bonuses

            // Deep copy technologies and set initial TRLs
            gameState.technologies = JSON.parse(JSON.stringify(technologies));
             Object.keys(gameState.selectedFaction.startTechLevels).forEach(techKey => {
                if (gameState.technologies[techKey]) {
                    gameState.technologies[techKey].trl = gameState.selectedFaction.startTechLevels[techKey];
                }
            });
             // Deep copy races
             gameState.races = JSON.parse(JSON.stringify(races));

            gameState.turn = 0;
            gameState.currentYear = START_YEAR;
            gameState.score = 0;
            gameState.gameOver = false;
            eventLogEl.innerHTML = ''; // Clear log on new game

            logEvent(`Selected faction: ${factionName}. Game begins!`);
            updateUI();
            startTurn(); // Start the first turn
        }

         function startTurn() {
            if (gameState.gameOver) return;
            console.log(`Starting Turn ${gameState.turn + 1}`);
            gameState.turn++;
            gameState.currentYear = START_YEAR + gameState.turn - 1;

            // --- Reset turn-specific modifiers before applying new ones ---
            // These track temporary effects from the *previous* turn's event
            const prevPublicFundsBonus = gameState.publicFundsBonus;
            const prevCorpFundsBonus = gameState.corpFundsBonus;
            const prevVCFundsMultiplier = gameState.vcFundsMultiplier;
            // These track temporary effects for the *current* turn's actions
            gameState.globalTRLBonus = 0.0;
            gameState.techCostMultipliers = {};
            gameState.techSuccessBonus = {};

            // --- Apply Funding Changes from Previous Turn's Event ---
            // Apply base growth/income FIRST
            const basePublicGrowth = gameState.bonuses.publicFundsGrowth !== undefined ? (1 + gameState.bonuses.publicFundsGrowth) : 1.05;
            const baseCorpGrowth = gameState.bonuses.corpFundsGrowth !== undefined ? (1 + gameState.bonuses.corpFundsGrowth) : 1.05;
            gameState.publicFunds = Math.round(gameState.publicFunds * basePublicGrowth + 50); // Base income + growth
            gameState.corpFunds = Math.round(gameState.corpFunds * baseCorpGrowth + 50); // Base income + growth

            // Now apply the *previous* turn's event bonus/malus to the new total
            gameState.publicFunds = Math.round(gameState.publicFunds * prevPublicFundsBonus);
            gameState.corpFunds = Math.round(gameState.corpFunds * prevCorpFundsBonus);

            // Calculate VC funds for this turn
            const baseVCMultiplier = gameState.bonuses.vcMultiplier || 1.0;
            const vcFluctuation = (Math.random() * 2 - 1) * VC_FUNDS_VOLATILITY;
            // Apply previous event multiplier THEN faction multiplier
            gameState.vcFunds = Math.max(0, Math.round((VC_FUNDS_BASE + vcFluctuation) * prevVCFundsMultiplier * baseVCMultiplier));

            // Add base RP
            gameState.researchPoints += RESEARCH_POINTS_PER_TURN;

            // --- Event Phase ---
            const randomEvent = events[Math.floor(Math.random() * events.length)];
            logEvent(`Turn ${gameState.turn} Event: ${randomEvent.name}`, 'event');

            // --- Reset next turn's modifiers (these will be set by the event effect) ---
            gameState.publicFundsBonus = 1.0; // Default to 1, event might change this for *next* turn
            gameState.corpFundsBonus = 1.0;   // Default to 1
            gameState.vcFundsMultiplier = 1.0; // Default to 1

            // Show event modal - effect is applied AFTER modal is closed via handleEventModalClose
            showEventModal(randomEvent);

            // Enable button for player actions AFTER event modal is potentially shown
            endTurnButton.disabled = false;
            updateUI(); // Update UI with new funds before player acts
        }

        function endTurn() {
            if (gameState.gameOver) return;
            console.log(`Ending Turn ${gameState.turn}`);
            endTurnButton.disabled = true; // Disable button during resolution

            // --- Resolution Phase ---
             // Check race completions (based on investments made during the turn)
             Object.values(gameState.races).forEach(race => {
                 if (!race.completed && gameState.technologies[race.techDependency]?.trl >= race.targetTRL && race.progress >= race.cost) {
                     race.completed = true;
                     gameState.score += race.reward;
                     logEvent(`Race Completed: ${race.name}! +${race.reward} Score!`, 'success');
                     updateRaceProgress(Object.keys(gameState.races).find(key => gameState.races[key] === race)); // Update the specific race card
                 }
             });

             // Update score based on current TRLs (simple ongoing score)
             let currentTRLScore = 0;
             Object.values(gameState.technologies).forEach(tech => currentTRLScore += tech.trl);
             gameState.score += Math.round(currentTRLScore / 2);


            // Check game over condition
            if (gameState.turn >= gameState.maxTurns) {
                gameState.gameOver = true;
                showGameOverModal();
                return; // Stop further processing
            }

            // Prepare for next turn
            updateUI(); // Update UI before starting next turn delay
            // Next turn starts after event modal is closed in startTurn() or immediately if no modal shown
             logEvent(`--- End of Turn ${gameState.turn} ---`, 'info');
             // The next turn is triggered by the event modal closing OR directly if no modal needed.
             // For simplicity here, we assume the event modal logic handles the transition.
             // If an event didn't need a modal, startTurn() would proceed directly.
             // If event modal is closed, handleEventModalClose triggers startTurn processing.
             // **Correction**: Let's ensure startTurn is called if the event modal isn't needed or after it's handled.
             // The current flow is: startTurn -> showEventModal -> (user closes modal) -> handleEventModalClose -> apply effect -> updateUI.
             // The next turn logic should be initiated *after* the player has had their action phase.
             // Let's rethink: endTurn should finalize the turn's results and then call startTurn.
             setTimeout(startTurn, 500); // Start next turn after a brief pause

        }

        function calculateTRLCost(techKey) {
            const tech = gameState.technologies[techKey];
            if (!tech || tech.trl >= 9) return { money: Infinity, rp: Infinity };
            // Recalculate base cost each time based on current TRL
            const baseMoney = BASE_TRL_COST_MONEY * Math.pow(TRL_COST_MULTIPLIER, tech.trl);
            const baseRP = BASE_TRL_COST_RP * Math.pow(TRL_COST_MULTIPLIER, tech.trl);
             // Apply temporary event cost multiplier if any
            const moneyMultiplier = gameState.techCostMultipliers[techKey] || 1.0;
             // Apply faction bonus for early TRLs
            const factionCostMultiplier = (tech.trl < 4 && gameState.bonuses.lowerEarlyTRLCost) ? gameState.bonuses.lowerEarlyTRLCost : 1.0;

            return {
                money: Math.round(baseMoney * moneyMultiplier * factionCostMultiplier),
                rp: Math.round(baseRP * moneyMultiplier * factionCostMultiplier)
            };
        }

        function attemptTRLIncrease(techKey, investedMoney, investedRP) {
            const tech = gameState.technologies[techKey];
            if (!tech || tech.trl >= 9) return;

            const costs = calculateTRLCost(techKey);
            const requiredMoney = costs.money;
            const requiredRP = costs.rp;

            // Ensure no division by zero
            const moneyRatio = requiredMoney > 0 ? Math.min(1, investedMoney / requiredMoney) : 1;
            const rpRatio = requiredRP > 0 ? Math.min(1, investedRP / requiredRP) : 1;
            // Weighted average - let's assume money is slightly more important
            const fundingRatio = (moneyRatio * 0.6 + rpRatio * 0.4);


            // Calculate success chance
            let successChance = BASE_TRL_SUCCESS_RATE * fundingRatio;
            const aiBonus = gameState.technologies['AI for Energy'] ? (gameState.technologies['AI for Energy'].trl * 0.01) : 0;
            successChance += aiBonus;
            if (gameState.bonuses.modularTechBonus && ['Solar PV', 'Li-ion Batteries', 'Next-Gen Batteries'].includes(techKey)) {
                successChance += gameState.bonuses.modularTechBonus;
            }
            successChance += gameState.techSuccessBonus[techKey] || 0; // Bonus for this specific tech this turn
            successChance += gameState.globalTRLBonus; // Global bonus this turn

            successChance = Math.min(0.95, Math.max(0.05, successChance));

            logEvent(`Attempting TRL increase for ${techKey}. Funding: ${Math.round(fundingRatio*100)}%. Final Chance: ${Math.round(successChance*100)}%.`, 'info');

            if (Math.random() < successChance) {
                tech.trl++;
                gameState.score += tech.trl * 5;
                logEvent(`${techKey} advanced to TRL ${tech.trl}! +${tech.trl * 5} Score.`, 'success');
                if (tech.trl === 5 || tech.trl === 8) {
                     tech.patents = (tech.patents || 0) + 1;
                     gameState.researchPoints += 5;
                     logEvent(`Patent secured for ${techKey}! +5 Research Points.`, 'info');
                 }
                 // Check if this TRL meets race requirement
                 Object.keys(gameState.races).forEach(raceKey => {
                     const race = gameState.races[raceKey];
                     if (race.techDependency === techKey && !race.completed) {
                         updateRaceProgress(raceKey); // Update race card to show TRL met
                     }
                 });

            } else {
                logEvent(`TRL increase attempt for ${techKey} failed this turn.`, 'warning');
            }
            updateTechnologyCard(techKey); // Update specific card display
            // No need to call updateUI here, it's called after investment confirmation
        }


        function investInRace(raceKey, amount) {
             const race = gameState.races[raceKey];
             if (!race || race.completed) return;

             // Ensure TRL requirement is met before allowing investment
             const tech = gameState.technologies[race.techDependency];
             if (!tech || tech.trl < race.targetTRL) {
                 logEvent(`Cannot invest in Race: ${race.name}. TRL requirement not met.`, 'warning');
                 return;
             }

             const affordableAmount = Math.min(amount, gameState.corpFunds); // Use Corp funds for races
             if (affordableAmount <= 0) {
                 logEvent(`Cannot invest in Race: ${race.name}. Insufficient Corp R&D funds.`, 'warning');
                 return;
             }


             gameState.corpFunds -= affordableAmount;
             race.progress += affordableAmount;
             gameState.score += Math.round(affordableAmount / 10);

             logEvent(`Invested $${affordableAmount}M in Race: ${race.name}. Progress: ${race.progress}/${race.cost}.`, 'info');
             updateRaceProgress(raceKey);
             updateUI(); // Update funds display immediately
         }


        // --- UI Update Functions ---

        function updateUI() {
            if (!gameState.selectedFaction || !playerNameEl) return; // Ensure elements are ready

            playerNameEl.textContent = gameState.selectedFaction.name;
            playerDescEl.textContent = gameState.selectedFaction.description;
            turnCounterEl.textContent = gameState.turn;
            maxTurnsEl.textContent = gameState.maxTurns;
            currentYearEl.textContent = gameState.currentYear;
            currentYearBtnEl.textContent = gameState.currentYear;
            playerScoreEl.textContent = gameState.score;
            publicFundsEl.textContent = gameState.publicFunds;
            corpFundsEl.textContent = gameState.corpFunds;
            vcFundsEl.textContent = gameState.vcFunds;
            researchPointsEl.textContent = gameState.researchPoints;

            techPathwaysContainer.innerHTML = '';
            Object.keys(gameState.technologies).forEach(key => {
                techPathwaysContainer.appendChild(createTechnologyCard(key));
            });

            racesContainer.innerHTML = '';
            Object.keys(gameState.races).forEach(key => {
                racesContainer.appendChild(createRaceCard(key));
            });

            modalPublicFundsEl.textContent = gameState.publicFunds;
            modalCorpFundsEl.textContent = gameState.corpFunds;
            modalResearchPointsEl.textContent = gameState.researchPoints;

            endTurnButton.disabled = gameState.gameOver;
        }

        function createTechnologyCard(techKey) {
            const tech = gameState.technologies[techKey];
            const costs = calculateTRLCost(techKey);
            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-lg shadow border border-gray-200 flex flex-col justify-between'; // Use flex for button placement
            card.id = `tech-card-${techKey.replace(/[\s/]+/g, '-')}`; // Sanitize ID

            const progressPercent = tech.trl >= 9 ? 100 : Math.round((tech.trl / 9) * 100);

            let content = `
                <div> <h3 class="text-md font-semibold text-gray-800 mb-1">${tech.name}</h3>
                    <p class="text-xs text-gray-500 mb-2">${tech.description}</p>
                    <div class="mb-2">
                        <span class="text-sm font-medium">TRL: ${tech.trl}/9</span>
                        ${tech.patents > 0 ? `<span class="ml-2 text-xs font-semibold text-yellow-600">(Patents: ${tech.patents})</span>` : ''}
                        <div class="trl-progress-bg mt-1">
                            <div class="trl-progress-bar" style="width: ${progressPercent}%">${progressPercent}%</div>
                        </div>
                    </div>
                </div>
                <div class="mt-auto"> `; // mt-auto pushes button down

            if (tech.trl < 9) {
                content += `
                    <p class="text-xs text-gray-600 mb-2">Next TRL Cost: $${costs.money}M, ${costs.rp} RP</p>
                    <button class="w-full bg-green-500 hover:bg-green-600 text-white text-sm font-medium py-1 px-3 rounded transition duration-150 ease-in-out" onclick="openInvestmentModal('${techKey}')">Invest</button>
                `;
            } else {
                content += `
                    <p class="text-xs text-green-600 font-semibold mb-2">Max TRL Reached!</p>
                    <button class="w-full bg-gray-400 text-white text-sm font-medium py-1 px-3 rounded cursor-not-allowed" disabled>Invest</button>
                `;
            }
             content += `</div>`; // Close button wrapper
            card.innerHTML = content;
            return card;
        }

         function updateTechnologyCard(techKey) {
            const card = document.getElementById(`tech-card-${techKey.replace(/[\s/]+/g, '-')}`);
            if (!card) return;
            // Just re-render the whole card for simplicity on update
            const newCardContent = createTechnologyCard(techKey).innerHTML;
            card.innerHTML = newCardContent;
        }


        function createRaceCard(raceKey) {
            const race = gameState.races[raceKey];
            const card = document.createElement('div');
            card.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 flex flex-col justify-between'; // Use flex
            card.id = `race-card-${raceKey.replace(/[\s/]+/g, '-')}`; // Sanitize ID

            const progressPercent = race.cost > 0 ? Math.min(100, Math.round((race.progress / race.cost) * 100)) : (race.completed ? 100 : 0);
            const tech = gameState.technologies[race.techDependency];
            const trlMet = tech && tech.trl >= race.targetTRL;

            let content = `
                <div> <h4 class="text-sm font-semibold text-gray-700">${race.name}</h4>
                    <p class="text-xs text-gray-500 mb-1">${race.description}</p>
                    <p class="text-xs text-gray-600 mb-1">Req. TRL: ${race.targetTRL} (${race.techDependency}) - ${trlMet ? '<span class="text-green-600 font-semibold">Met</span>' : '<span class="text-red-600 font-semibold">Not Met</span>'}</p>
                    <div class="trl-progress-bg mb-1">
                         <div class="trl-progress-bar ${race.completed ? 'bg-green-500' : 'bg-purple-500'}" style="width: ${progressPercent}%">${progressPercent}%</div>
                    </div>
                    <p class="text-xs text-gray-600 mb-2">Progress: $${race.progress}M / $${race.cost}M</p>
                </div>
                 <div class="mt-auto"> `; // mt-auto pushes button down

            if (!race.completed && trlMet) {
                content += `<button class="w-full bg-purple-500 hover:bg-purple-600 text-white text-xs font-medium py-1 px-2 rounded transition duration-150 ease-in-out" onclick="investInRace('${raceKey}', 50)">Invest $50M (Corp)</button>`;
            } else if (race.completed) {
                content += `<p class="text-xs text-green-600 font-semibold">Completed!</p>`;
            } else { // Not completed, TRL not met
                content += `<button class="w-full bg-gray-400 text-white text-xs font-medium py-1 px-2 rounded cursor-not-allowed" disabled>Invest (TRL Req.)</button>`;
            }
             content += `</div>`; // Close button wrapper
            card.innerHTML = content;
            return card;
        }

         function updateRaceProgress(raceKey) {
             const card = document.getElementById(`race-card-${raceKey.replace(/[\s/]+/g, '-')}`);
             if (!card) return;
             // Just re-render the whole card for simplicity on update
             const newCardContent = createRaceCard(raceKey).innerHTML;
             card.innerHTML = newCardContent;
         }


        function logEvent(message, type = 'info') {
            console.log(`Event Log (${type}):`, message);
             if (!eventLogEl) return; // Ensure element exists

            const logEntry = document.createElement('p');
            // Add turn number only if game has started
            const turnPrefix = gameState.turn > 0 ? `[Turn ${gameState.turn}] ` : '';
            logEntry.textContent = `${turnPrefix}${message}`;
            logEntry.classList.add('text-xs', 'event-item', 'mb-1'); // Add animation class and margin

            switch (type) {
                case 'success': logEntry.classList.add('text-green-700', 'font-medium'); break;
                case 'warning': logEntry.classList.add('text-yellow-700'); break;
                case 'error': logEntry.classList.add('text-red-700', 'font-semibold'); break;
                case 'event': logEntry.classList.add('text-blue-700', 'font-semibold'); break;
                default: logEntry.classList.add('text-gray-700');
            }

            if (eventLogEl.firstChild) {
                eventLogEl.insertBefore(logEntry, eventLogEl.firstChild);
            } else {
                eventLogEl.appendChild(logEntry);
            }

            while (eventLogEl.childElementCount > 30) {
                 eventLogEl.removeChild(eventLogEl.lastChild);
             }
             // Scroll to top
             eventLogEl.scrollTop = 0;
        }

        // --- Modal Functions ---

        function showEventModal(eventData) {
            // Store the event effect function to be called on close
            eventModal.dataset.effectFunction = () => eventData.effect(gameState);
            eventDescriptionEl.textContent = eventData.description;
            eventModal.style.display = 'flex'; // Use flex for centering
        }

         // Function to handle closing the event modal and applying effects
         function handleEventModalClose() {
             const effectFunc = eventModal.dataset.effectFunction;
             if (effectFunc && typeof window[effectFunc] === 'function') {
                 // This approach is problematic as dataset stores strings, not functions directly.
                 // We need to store the actual function or call it directly.
                 // Let's call the stored effect directly.
             }
             // Apply the effect stored when the modal was shown
             const effectToApply = eventModal.effectCallback; // Use a temporary property
             if (effectToApply && typeof effectToApply === 'function') {
                 effectToApply(gameState);
             }

             closeModal('event-modal'); // Close the modal visually
             updateUI(); // Update UI *after* effect is applied
         }
         // Modify showEventModal to store the callback correctly
         function showEventModal(eventData) {
             eventModal.effectCallback = eventData.effect; // Store the function
             eventDescriptionEl.textContent = eventData.description;
             eventModal.style.display = 'flex';
         }


        function openInvestmentModal(techKey) {
             gameState.investingTechKey = techKey;
             const tech = gameState.technologies[techKey];
             const costs = calculateTRLCost(techKey);

             investTechNameEl.textContent = tech.name;
             investTechTrlEl.textContent = tech.trl;
             investTechCostEl.textContent = costs.money;
             investTechRpCostEl.textContent = costs.rp;

             publicInvestmentInput.value = 0;
             corpInvestmentInput.value = 0;
             rpInvestmentInput.value = 0;
             modalPublicFundsEl.textContent = gameState.publicFunds;
             modalCorpFundsEl.textContent = gameState.corpFunds;
             modalResearchPointsEl.textContent = gameState.researchPoints;
             investmentErrorEl.style.display = 'none';

             investmentModal.style.display = 'flex'; // Use flex for centering
         }

         function handleConfirmInvestment() {
             const publicInvest = parseInt(publicInvestmentInput.value) || 0;
             const corpInvest = parseInt(corpInvestmentInput.value) || 0;
             const rpInvest = parseInt(rpInvestmentInput.value) || 0;
             const techKey = gameState.investingTechKey;

             if (!techKey) return;

             const totalMoneyInvest = publicInvest + corpInvest;

             if (publicInvest > gameState.publicFunds || corpInvest > gameState.corpFunds || rpInvest > gameState.researchPoints) {
                 investmentErrorEl.textContent = 'Investment exceeds available resources.';
                 investmentErrorEl.style.display = 'block';
                 return;
             }
              if (publicInvest < 0 || corpInvest < 0 || rpInvest < 0) {
                 investmentErrorEl.textContent = 'Investment values cannot be negative.';
                 investmentErrorEl.style.display = 'block';
                 return;
             }

             gameState.publicFunds -= publicInvest;
             gameState.corpFunds -= corpInvest;
             gameState.researchPoints -= rpInvest;

             logEvent(`Invested $${publicInvest}M (Public), $${corpInvest}M (Corp), ${rpInvest} RP in ${techKey}.`, 'info');

             attemptTRLIncrease(techKey, totalMoneyInvest, rpInvest);

             closeModal('investment-modal');
             gameState.investingTechKey = null;
             updateUI(); // Update main UI
         };


        function closeModal(modalId) {
             const modal = document.getElementById(modalId);
             if(modal) {
                modal.style.display = 'none';
                // Clear any stored callbacks if needed, e.g., for event modal
                if (modalId === 'event-modal') {
                    modal.effectCallback = null;
                }
             }
        }

        function showGameOverModal() {
            finalScoreEl.textContent = gameState.score;
             let message = `The innovation race concludes in ${gameState.currentYear}. `;
             if (gameState.score > 500) {
                 message += "Your leadership has significantly advanced global energy technology! A remarkable achievement!";
             } else if (gameState.score > 200) {
                 message += "You made significant strides in energy innovation, contributing well to the future.";
             } else {
                 message += "The path of innovation was challenging. More effort is needed for the next energy era.";
             }
             gameOverMessageEl.textContent = message;
            gameOverModal.style.display = 'flex'; // Use flex for centering
            endTurnButton.disabled = true;
        }

        // --- Initialize ---
        // Use DOMContentLoaded to ensure all elements are available before getting references
        document.addEventListener('DOMContentLoaded', initGame);

    </script>

</body>
</html>

